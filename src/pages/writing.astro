---
import Base from "../layouts/Base.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type PostEntry = CollectionEntry<"writing"> | CollectionEntry<"drafts">;

const writingPosts = await getCollection("writing");
const pageTitle = "É. Urcades: Ongoing Writing";

// In development mode, include drafts alongside published posts
let allPosts: PostEntry[] = writingPosts;
if (import.meta.env.DEV) {
  const draftPosts = await getCollection("drafts");
  allPosts = [...writingPosts, ...draftPosts];
}

function groupPostsByYear(posts: PostEntry[]): Record<string, PostEntry[]> {
  const grouped = posts.reduce(
    (acc, post) => {
      const year = post.data.pubDate.getFullYear().toString();
      acc[year] = acc[year] || [];
      acc[year].push(post);
      return acc;
    },
    {} as Record<string, PostEntry[]>
  );

  // Sort each year's posts once after grouping (O(n + klog(k)) instead of O(n²log(n)))
  Object.values(grouped).forEach((yearPosts) => {
    yearPosts.sort(
      (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
    );
  });

  return grouped;
}

function isDraft(post: PostEntry): boolean {
  return post.collection === "drafts";
}

const groupedPosts = groupPostsByYear(allPosts);
const sortedYears = Object.keys(groupedPosts).sort(
  (a, b) => Number(b) - Number(a)
);
---

<style>
  li {
    list-style: circle;
  }
</style>

<Base pageTitle={pageTitle}>
  {
    sortedYears.map((year) => (
      <>
        <em>{year}</em>
        <ul>
          {groupedPosts[year]?.map((post) => (
            <li>
              <a
                href={`/${post.collection}/${post.id}/`}
                title={post.data.pubDate.toISOString()}
              >
                {isDraft(post) && "[DRAFT] "}
                {post.data.title}
              </a>
            </li>
          ))}
        </ul>
      </>
    ))
  }
  <br />
  <p><a href="https://urcades.substack.com/">Subscribe</a></p>
  <p><a href="/rss.xml">RSS</a></p>
</Base>
